#include <stdio.h>
#include <string.h>
#include <time.h>

#include "filename.h"
#include "DesUtil.h"
#include "IBsecBox.h"

static unsigned char SYS_MAC_KEY_DATA[224]=
{
  0x71,0x9A,0x94,0x80,0x24,0xC8,0x25,0x66,
  0x62,0xD2,0x5E,0xC3,0xFE,0x4E,0x51,0xCD,
  0x53,0x6E,0x49,0x8D,0x2A,0x45,0x9B,0x06,
  0xC2,0x39,0x30,0x66,0x7F,0x61,0x6E,0xCC,
  0xD5,0x2A,0x2C,0x55,0x02,0xA2,0x61,0xE6,
  0xA1,0x3E,0xDD,0x22,0xE2,0xA4,0xC5,0x57,
  0xC8,0x69,0x9D,0xA7,0x5E,0x6B,0xC7,0xB3,
  0xAC,0xE0,0x8D,0xF1,0xC7,0x6C,0xA6,0xCC,
  0xB8,0x21,0xCD,0xE0,0xC5,0x56,0xC0,0x3B,
  0x49,0xCA,0x51,0x3A,0xE6,0x02,0x35,0xCD,
  0x47,0x6E,0x78,0xFF,0x0A,0x1D,0x50,0xF7,
  0xBC,0x16,0x12,0xCA,0x6E,0x95,0x48,0x55,
  0x57,0x1E,0xD9,0xAB,0x34,0xBB,0x33,0x9E,
  0x06,0xB5,0xB1,0x28,0x19,0x44,0x72,0xF6,
  0xE1,0xBC,0xA7,0x4C,0x36,0x13,0x34,0x44,
  0x76,0x01,0x44,0xED,0xA3,0x8B,0x53,0x78,
  0x07,0x6C,0xCD,0xA9,0x09,0x33,0x06,0xB7,
  0xB5,0x02,0x40,0xA5,0xA6,0xBA,0x91,0xA6,
  0x65,0x2F,0xB9,0x7B,0x38,0x43,0x4F,0xDD,
  0xB5,0xAF,0xAE,0x99,0x55,0x09,0x44,0x9C,
  0x62,0xC0,0x09,0xF2,0xF7,0xFC,0x02,0x5F,
  0x0A,0x11,0x16,0x2E,0x6F,0x1B,0xD2,0x09,
  0xCC,0xE1,0xCB,0x5A,0x93,0xE2,0xC2,0xB4,
  0xEA,0xF8,0x1D,0x91,0x20,0x11,0x9D,0x2E,
  0xD5,0x85,0x3C,0x72,0x6D,0x07,0x47,0x74,
  0xA7,0x9E,0x09,0xDA,0xD7,0x6C,0x93,0x5C,
  0x37,0xDA,0x5E,0x15,0x87,0x56,0xF5,0x7F,
  0x63,0xA4,0x5A,0x2A,0x7A,0x88,0xAB,0xCE   
};

static unsigned char SYS_CRYPT_KEY_DATA[298]=
{
  0x71,0x9A,0x94,0x80,0x24,0xC8,0x25,0x66,
  0x62,0xD2,0x5E,0xC3,0xFE,0x4E,0x51,0xCD,
  0x53,0x6E,0x49,0x8D,0x2A,0x45,0x9B,0x06,
  0xC2,0x39,0x30,0x66,0x7F,0x61,0x6E,0xCC,
  0xD5,0x2A,0x2C,0x55,0x02,0xA2,0x61,0xE6,
  0xA1,0x3E,0xDD,0x22,0xE2,0xA4,0xC5,0x57,
  0xC8,0x69,0x9D,0xA7,0x5E,0x6B,0xC7,0xB3,
  0xAC,0xE0,0x8D,0xF1,0xC7,0x6C,0xA6,0xCC,
  0xB8,0x21,0xCD,0xE0,0xC5,0x56,0xC0,0x3B,
  0x49,0xCA,0x51,0x3A,0xE6,0x02,0x35,0xCD,
  0x47,0x6E,0x78,0xFF,0x0A,0x1D,0x50,0xF7,
  0xBC,0x16,0x12,0xCA,0x6E,0x95,0x48,0x55,
  0x57,0x1E,0xD9,0xAB,0x34,0xBB,0x33,0x9E,
  0x06,0xB5,0xB1,0x28,0x19,0x44,0x72,0xF6,
  0xE1,0xBC,0xA7,0x4C,0x36,0x13,0x34,0x44,
  0x76,0x01,0x44,0xED,0xA3,0x8B,0x53,0x78,
  0x07,0x6C,0xCD,0xA9,0x09,0x33,0x06,0xB7,
  0xB5,0x02,0x40,0xA5,0xA6,0xBA,0x91,0xA6,
  0x65,0x2F,0xB9,0x7B,0x39,0x44,0x4F,0xDD,
  0xB5,0xAF,0xAE,0x99,0x55,0x09,0x44,0x9C,
  0x62,0xC0,0x09,0xF2,0xF7,0xFC,0x02,0x5F,
  0x0A,0x11,0x16,0x2E,0x6F,0x1B,0xD2,0x09,
  0xCC,0xE1,0xCB,0x5A,0x93,0xE2,0xC2,0xB4,
  0xEA,0xF8,0x1D,0x91,0x20,0x11,0x9D,0x2E,
  0xD5,0x85,0x3C,0x72,0x6D,0x07,0x47,0x74,
  0xA7,0x9E,0x09,0xDA,0xD7,0x6C,0x93,0x5C,
  0x37,0xDA,0x5E,0x15,0x87,0x56,0xF5,0x7F,
  0x63,0xA4,0x5A,0x2A,0x7A,0x88,0xAB,0xCE,
  0x03,0x0E,0x4A,0x04,0xF2,0xEE,0xBC,0x5F,
  0x2B,0x00,0x8A,0xB5,0xDC,0x5C,0xB1,0xF0,
  0xCE,0x32,0x71,0xC3,0xF9,0x7E,0xB6,0xF7,
  0xDD,0x3B,0xD0,0x35,0x17,0x15,0xB0,0x68,
  0xF4,0xF2,0x67,0x88,0x3E,0xA5,0x1B,0x26,
  0x1E,0x96,0x82,0xF7,0xF2,0x3D,0x40,0x18,
  0xE6,0x8F,0x71,0x25,0xB3,0x51,0x04,0x74,
  0x27,0x41,0xB9,0xFD,0x14,0x57,0x8F,0x97,
  0x6F,0xEB,0x4F,0x80,0x15,0x75,0x40,0xD6,
  0xEC,0x7F   
};

static unsigned char SYS_M_KEY_DATA[167]=
{
  0x71,0x9A,0x94,0x80,0x24,0xC8,0x25,0x66,
  0x62,0xD2,0x5E,0xC3,0xFE,0x4E,0x51,0xCD,
  0x53,0x6E,0x49,0x8D,0x2A,0x45,0x9B,0x06,
  0xC2,0x39,0x30,0x66,0x7F,0x61,0x6E,0xCC,
  0xD5,0x2A,0x2C,0x55,0x02,0xA2,0x61,0xE6,
  0xA1,0x3E,0xDD,0x22,0xE2,0xA4,0xC5,0x57,
  0xC8,0x69,0x9D,0xA7,0x5E,0x6B,0xC7,0xB3,
  0xAC,0xE0,0x8D,0xF1,0xC7,0x6C,0xA6,0xCC,
  0xB8,0x21,0xCD,0xE0,0xC5,0x56,0xC0,0x3B,
  0x49,0xCA,0x51,0x3A,0xE6,0x02,0x35,0xCD,
  0x47,0x6E,0x78,0xFF,0x0A,0x1D,0x50,0xF7,
  0xBC,0x16,0x12,0xCA,0x6E,0x95,0x48,0x55,
  0x57,0x1E,0xD9,0xAB,0x34,0xBB,0x33,0x9E,
  0x06,0xB5,0xB1,0x28,0x19,0x44,0x72,0xF6,
  0xE1,0xBC,0xA7,0x4C,0x36,0x13,0x34,0x44,
  0x76,0x01,0x44,0xED,0xA3,0x8B,0x53,0x78,
  0x07,0x6C,0xCD,0xA9,0x09,0x33,0x06,0xB7,
  0xB5,0x02,0x40,0xA5,0xA6,0xBA,0x91,0xA6,
  0x65,0x2F,0xB9,0x7B,0x38,0x43,0x4F,0xDD,
  0xB5,0xAF,0xAE,0x99,0x55,0x09,0x44,0x8F,
  0x3E,0xAA,0xCF,0x58,0x97,0x6F,0xB8  
};

char         MKEY[25];
static char  MAC_KEY[25];
static char  CRYPT_KEY[25];

static struct
{
  time_t  save_time;
  char    fill[16];
  char    dbname[16];
  char    dbpasswd[10];
  char    keyA[16];
  char    keyB[16];
  char    mac[8];
} sec;

int IBsecBoxInit()
{
  static int  initF = 0;
  char        key[24];
  char        tempKey[25];


  if (initF == 1)
    return 0;

  memset(&sec,0,sizeof(sec));
  memset(MKEY,0,sizeof(MKEY));
  memset(MAC_KEY,0,sizeof(MAC_KEY));
  memset(CRYPT_KEY,0,sizeof(CRYPT_KEY));

  memset(key,0,sizeof(key));
  memset(tempKey,0,sizeof(tempKey));

  desmCreat24MAC(key,DES_MODE_3,(char *)SYS_M_KEY_DATA,sizeof(SYS_M_KEY_DATA),tempKey);
  memcpy(MKEY,tempKey,16);
  MKEY[16] = 0;

  memset(tempKey,0,sizeof(tempKey));
  desmCreat24MAC(key,DES_MODE_3,(char *)SYS_MAC_KEY_DATA,sizeof(SYS_MAC_KEY_DATA),tempKey);
  memcpy(MAC_KEY,tempKey,16);
  MAC_KEY[16] = 0;

  memset(tempKey,0,sizeof(tempKey));
  desmCreat24MAC(key,DES_MODE_3,(char *)SYS_CRYPT_KEY_DATA,sizeof(SYS_CRYPT_KEY_DATA),tempKey);
  memcpy(CRYPT_KEY,tempKey,16);
  CRYPT_KEY[16] = 0;

  initF = 1;

  return 0;
}

static int CreateSecBoxMAC(char *mac)
{
  char  buf[512];
  char  str1[33];
  char  str2[33];

  binToStr(str1,sec.keyA,16);
  binToStr(str2,sec.keyB,16);

  sprintf(buf,"%d|%s|%s|%s|%s|%s",
    sec.save_time,sec.fill,sec.dbname,sec.dbpasswd,str1,str2);

  desmCreatMAC(MAC_KEY,DES_MODE_3,buf,strlen(buf),mac);

  return 0;
}

int IBsecBoxLoadMKey(char *dbname,char *dbpasswd,char *keyA,char *keyB)
{
  FILE    *in;
  int     n;
  char    mac[9];

  IBsecBoxInit();

  in = fopen(GetEtcFileName("IBSECMKEY"),"r");

  if (in==NULL)
  {
    logger(__FILE__,__LINE__,"安全文件 IBSECMKEY 不存在.");
    return -1;
  }


  n = fread(&sec,sizeof(sec),1,in);

  fclose(in);


  if (n != 1)
  {
    logger(__FILE__,__LINE__,"安全文件 IBSECMKEY 非法.");
    return -1;
  }

  dedesmBlock(CRYPT_KEY,DES_MODE_3,(char *)&sec,sizeof(sec));

  CreateSecBoxMAC(mac);


  if (memcmp(mac,sec.mac,8)!=0)
  {
    logger(__FILE__,__LINE__,"安全文件 IBSECMKEY 非法.");
    return -1;
  }

  memcpy(keyA,sec.keyA,16);
  memcpy(keyB,sec.keyB,16);
  strcpy(dbname,sec.dbname);
  strcpy(dbpasswd,sec.dbpasswd);

  return 0;
}

int IBsecBoxSaveMKey(char *dbname,char *dbpasswd,char *keyA,char *keyB)
{
  FILE  *out;
  int    n;

  IBsecBoxInit();

  memset(&sec,0,sizeof(sec));

  time(&sec.save_time);
  strcpy(sec.fill,"NETFLY");
  strncpy(sec.dbname,dbname,15);
  strncpy(sec.dbpasswd,dbpasswd,8);
  memcpy(sec.keyA,keyA,16);
  memcpy(sec.keyB,keyB,16);
  CreateSecBoxMAC(sec.mac);
  endesmBlock(CRYPT_KEY,DES_MODE_3,(char *)&sec,sizeof(sec));

  out=fopen(GetEtcFileName("IBSECMKEY"),"w");
  if (out == NULL)
  {
    logger(__FILE__,__LINE__,"安全文件 IBSECMKEY 不存在.");
    return -1;
  }

  n = fwrite(&sec,sizeof(sec),1,out);

  fclose(out);

  if (n != 1)
  {
    logger(__FILE__,__LINE__,"更新安全文件 IBSECMKEY 失败.");
    return -1;
  }

  return 0;
}

int IBsecBoxClean()
{
  FILE  *out;
  int   n;

  out = fopen(GetEtcFileName("IBSECMKEY"),"w");
  if (out == NULL)
  {
    logger(__FILE__,__LINE__,"安全文件 IBSECMKEY 不存在.");
    return -1;
  }

  fclose(out);

  return 0;
}
